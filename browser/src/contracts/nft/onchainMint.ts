import { Data, Lucid, Tx, AddressDetails, TxHash, Constr, applyParamsToScript, MintingPolicy, SpendingValidator, fromText, toUnit, PolicyId } from "lucid-cardano"
import { CompiledNFTInstance } from "../../services/nft-script-compiler"
import * as H from "../helpers"
import {NFTMetadata, RoyaltyInfo, DatumNFTMetadata, Metadata222, MetadataEvolveDatum, toAddress, toAssets, fromAssets, fromAddress} from "./onchainTypes"

/* NFT minting policy parameterized by a wallets TxOutRef.
  NB vulcan-server must be running 
*/
const onchainNFTCbor = "59055e59055b0100003232323232323232323232323232323232323232322223232323232323232533301b3370e9000001099191919192999810191919299981199b874800800854ccc08ccdc3802240042646603c66e1cdd69814000980aa400466e3cccdc62400090041bae302900101d3020005153330233370e0089002099191991919119800801801199b8c48020dc6801001199b8c480012008001375c6054004446646464466002006004666e312008371a004004666e31200048020004dd71816001911981199b87375a605a00c603490011981199b87375a605a00a603490011981199b8f003001330233371e00804066e3c008084c084c088018c08001454ccc08ccdc38022400c26464646646464466002006004666e312008371a004004666e31200048020004dd71815801911991919119800801801199b8c48020dc6801001199b8c480012008001375c605a00844660486603801a0346604866e1cdd69817003980da40046604866e1cdd69817003180da40046604866e1cdd69817002980da40046604866e3c010084cc090cdc78010111981219b8f3337189000240106eb8c0bc01408ccdc7800801981118108039810981100318100028b0a99981199b87004480104c8c8cc8c8c88cc00400c008ccdc6240106e34008008ccdc62400090040009bae302a00222332323223300100300233371890041b8d0020023337189000240100026eb8c0b000c88cc08ccc06c030064cc08ccdc39bad302d00648008cc08ccdc39bad302d00548008cc08ccdc78020101981199b8f0020213371e0020066042604400c604000a2a66604666e1c01120061323232332323223300100300233371890041b8d0020023337189000240100026eb8c0ac00c88cc8c8c88cc00400c008ccdc6240106e34008008ccdc62400090040009bae302d00422332323223300100300233371890041b8d0020023337189000240100026eb8c0bc01488cc098cc07803c070cc098cdc39bad303000948008cc098cdc39bad303000848008cc098cdc39bad303000748008cc098cdc78030119981319b8f004024330263371e00404a6604c66e3c00c014cdc7800a4507526f79616c747900302230210073021302200630200051630260023026001375401e2930b19980d1112999811800880109980199b8000248008c0800052000001323301a22533302200116153330213375e604c603c00200c26eacc094c0780044c008c07c004004dd5980d99180e980d800980e0011bac301a001301b30190053018001153301e4915d5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f4d657461646174612f4f6e636861696e4e46544d696e742e68733a3133303a332d31370016301e002301e0013754602a602c002602c00aa66602c66e1d20000021324994ccc05c004526153301901816153330163370e900100109924ca66602e0022930a9980c80c0b0a9980ca4813f7265616368656420656e64206f662073756d207768696c65207374696c6c206e6f7420686176696e6720666f756e642074686520636f6e7374727563746f720016301900230190013754004466e0520000012233003233007002300e30100010022300922533301100114a02a660086006601a00226004601c00246601a002004294488cdd79ba7300b002374e601600291104000643b000488104000de14000488104001f4d7000223330080020014a0464600446600400400246004466004004002460066006002ae855d1118031baa0015734aae7d241317074727946726f6d2850446174615265636f72645b5d293a206c697374206973206c6f6e676572207468616e207a65726f005738aae7955ce9"
const metadataControlEvolveCbor = "591bae591bab0100003232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232322222323232323232323233332222323232323232533307e3370e9001001099191919191929998420099b87480080084cc8c8c8c8c88ccc00401000c008dd69847008019bae308e01002375c611a02004603c6eacc22c04004c0740108894ccc21c04c8c8c94ccc22804cdc3a40040042646464646464a66128026466e59241065054784f7574003372c0d466e58138c8cdcb19b964910761646472657373003372c0a26466e581a8cdcb19b96491085041646472657373003372c0d866e58140c8cdcb19b964910a63726564656e7469616c003372c0a66060612e0200266e5813cc8cdcb19b964901117374616b696e6743726564656e7469616c003372c0a864646464a6661320266e1d200200213372c0e066e58cdcb03899b9607207307413372c0e066e58cdcb02a99b960723372c0ac66e58cdcb02b99b9605832323232533309d013370e9001001099b960743372c66e592410b505374616b696e67507472003372c0ec66e58168cdcb19b9605b3372c0b860a66eb4c28004004cdcb02c1919b963372c9201025f31003372c0ba60a86eb4c28404004cdcb02c9919b963372c9201025f32003372c0bc60aa6eb4c288040041ecc28004004c27c040041e04cdcb03a19b963372c9210c505374616b696e6748617368003372c0ec66e58168cdcb19b9605b3372c0b860726140020020f20f06144020046144020026ea8004c270040041d41d0c27804008c27804004dd5000984c00800838984b00800983f000837184a8080099b9604d323372c66e592410576616c7565003372c0a46466e581accdcb19b96491065056616c7565003372c0da66e581accdcb19b9603a3372c0da66e58144cdcb198480091299984980800882d099299984a00800899b9606e3372c60746eb8c27804c26804008cdcb02119b96303c3756613a026134020040e4266e58cdcb03719b96303a375c613c0261340200466e58108cdcb181e1bab309d01309a010020723372c0a460066132020046130020020020e00de0de6eacc25804004cdcb0271919b963372c920105646174756d003372c0a664646464a6661300266e1d200000213372c0de66e58cdcb2490e504e6f4f7574707574446174756d003372c0e20e40e62a6661300266e1d200200213372c0de66e58cdcb248110504f7574707574446174756d48617368003372c0e266e58154cdcb19b9649109646174756d48617368003372c0ae6466e581c0cdcb19b964910a50446174756d48617368003372c0e460b20020e86eb8c26c040041d01cc4cdcb03799b963372c9210c504f7574707574446174756d003372c0e266e58154cdcb19b964910b6f7574707574446174756d003372c0ae6466e581c0cdcb19b964910650446174756d003372c0e4a666132029444cdcb03819b96304500107413045001074309b01001074073309d01002309d010013754002612e0200266e5813cc8cdcb19b9649010f7265666572656e6365536372697074003372c0a864646464a6661320266e1d200000213372c0e066e58cdcb02a99b960723372c0ac66e58cdcb02b99b96058323372c0e266e58cdcb2490b5053637269707448617368003372c0e660b40020ea6eb8c270040041d41d04cdcb03819b963372c0e266e581c81cc1d0c27804008c27804004dd5000984c00800838984b00800984a80800984a00800983e000998369bac3093010163093010011323232325333094013370e900200109919191919191983d99b88375a613a0201c6eb4c27404034cc1eccccc8888ccc268048894ccc278040084cc24c048cc02001cdd5985400800800899299984f808010a9984a809980400080389984a009198049bab30a90100100830a401003132323253330a5013371e0040022a66130026601600800626600e614e0200c614e0200a2a66614a0266e4000800454cc26004cc02c0100284cc01cc29c0401801454cc26004cc02c02800c4cc01c018c29c04014dd71855809853808021bae30aa0130a6010043756615002614a020046eacc29c04c29004008008004c888ccc264048894ccc274040084cc248048cdc48039bad30a701001001132533309e010021533094013371200200e26612602466e24dd6985400800804185180801899191929998520099b8f0020011533097013371200800626600e614c0200c614c0200a2a6661480266e4000800454cc25c04cdc48020050998039853008030028a9984b8099b8900a00313300700630a601005375c615402614c020086eb8c2a404c29404010dd69853809852008011bad30a60130a3010020020014800026004dd5984e808061bab32309e01309d01308601001330773758613a02040613a02016660f666e1ccdc01bad309d0100e48008dd6984e808021983d99baf309d0100d309d010033307b3375e613a02018613a02004660f666ebcc2740402cc27404004cc1ecc8ccc26c04c1e8c27804c27404008004c1ec005289983d9983e00d1841009bab309d0100a3375e613a02020613a0200c613602002613402002613202002610202613202613002002612e0200260fe60f4612e020022a66130029215e5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f4d657461646174612f4f6e636861696e4e46544d696e742e68733a3238393a31392d34370016309901002309901001375461280261260200261240260f6660ee6eb0c24c04058dd7184980806984880800984800800984780800983b984780984700800984680800983a80a8a9998450099b87480100084cdc3999836805003002983424004264646464646464646464a6661280266e1d200400213232323232323307b337106eb4c27404038dd6984e808069983d99baf309d0100c309d010023307b3375e613a0201c613a02008660f666ebcc27404034c2740400ccc1eccdd7984e80805984e808009983d9919984d80983d184f00984e80801000983d800a503307b3307c01a3082013756613a02014664612e0244a66613402002294054cc24c04c00cc280040044c008c27c040048cdc399983f191bab309f01309e01308701001309e01309d013086010010274881094f776e6572736869700048008dd6184e80810984d80800984d00800984c80800984080984c80984c00800984b80800983f983d184b808008a9984c00a4815e5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f4d657461646174612f4f6e636861696e4e46544d696e742e68733a3236353a31392d34370016309901002309901001375461280261260200261240260f6660ee6eb0c24c04058dd7184980806984880800984800800984780800983b984780984700800984680800983a80a9847808011847808009baa01114985854cc220052415d5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f4d657461646174612f4f6e636861696e4e46544d696e742e68733a3235323a352d35340016308901002308901001375464610a0260da00261080200660d06eacc20c04004c20404004c1a4cc88cc1f0894ccc1fc004584c94ccc20c04cc1b4010c218040044c21804c214040044c00cc21404008c1b4c21404004008dd61840808029840808008a9984100a4815d5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f4d657461646174612f4f6e636861696e4e46544d696e742e68733a3234383a352d34320016308301002308301001375460fc60fa00660f860f800260c860f800260c60026eb803002c0280254ccc1cccdc3a40000042649329998380008a4c2a660ee0c02c2a6660e666e1d20020021324994ccc1c0004526153307706016153330733370e900200109924ca6660e00022930a9983b8300b0a9983b83c0b183c001183c0009baa006533306f3370e9000001099191919191919191919191924ca6660ee0022930a9983f0338b183d803299983c19b87480000084c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c926533308901001149854cc240041e458c23404008c23404004c22c040194ccc22004cdc3a4000004264646464646464646464646464932999848808008a4c2a6613002102022c612a0200ca6661240266e1d20000021323232323232324994ccc25404004526153309c0108501163099010065333096013370e900000109919191919191924ca666132020022930a9985000844808b184e80803299984d0099b87480000084c8c94ccc27004cdc39b8d001480e04c8c926533309a01001149854cc284042280458c2780400c54cc280042200458dd7000984e808008a99984d0099b87480080084c8c94ccc27004cdc39b8d001480e04c8c926533309a01001149854cc284042280458c2780400c54cc280042280458dd7000984e808008a9984f0084f808b184f80801184f808009baa00130990100115333096013370e900100109919191919191919191924ca666138020022930a9985180846008b1850008019bad001309f01001309d01003375a0026138020026134020066eb4004c2640400454cc2680426c0458c26c04008c26c04004dd5000984a808008a9998490099b87480080084c926533308f01001149854cc258041fc5854cc2580425c0458c25c04008c25c04004dd500098488080098478080329998460099b87480000084c8c94ccc23804cdc39b8d001480e04c8c926533308c01001149854cc24c041f058c2400400c54cc248041e858dd70009847808008a9998460099b87480080084c8c94ccc23804cdc39b8d001480e04c8c926533308c01001149854cc24c041f058c2400400c54cc248041f058dd70009847808008a9984800848808b1848808011848808009baa001308b01001153308c0108d0116308d01002308d010013754002610e02002610a0200c60e26eac010c1e8dd58019983d919bb032325333083015330793370e0029000099b87001480e04c2280400c54cc21c041ec58dc68009bae308801001323232308a01004307c3756611202006660fa466ec0c94ccc21004cdc49b8d001481004c22c0400854cc220042140458dd7184500800991845008011bad3089010010013756610e020020026eac004c20404004c1fc00cdd6800983f000983e0019bad001307b001153307c07d16307d002307d001375400260ee00260ea0066eb4004c1d0004c1c8008c1c800454cc1cc1d058c1d0008c1d0004dd5001929998328008a998360010b0992999833000898360010a998368020b1835000a490e4c69737420697320656d7074792e004901244c69737420636f6e7461696e73206d6f7265207468616e206f6e6520656c656d656e742e00232323253330683370e9000001099b9603f3372c66e58014cdcb02099b960253372c66e58098cdcb01398031bae306b00104404313372c07e66e58cdcb00419b960413372c04a66e58cdcb01319b960273009375c60d600208808660da00460da0026ea800524111505075624b657943726564656e7469616c0023372c07466e58cdcb00119b9603c302300103e4910b505075624b657948617368004901115053637269707443726564656e7469616c0023372c06e66e58cdcb00119b96039302000103b4910e5056616c696461746f72486173680023372c00466e580dcc07800524010f5043757272656e637953796d626f6c0023372c00466e580d4c00c005240104504d61700023372c02e66e58c0080040d8c150894ccc15c00440784c94ccc1600044cdcb01919b963004375c60c460bc00466e58018cdcb18089bad3061305e00203613372c66e580c8cdcb18021bae3062305e0023372c00c66e58c044dd69830982f00101b19b960163003305d002305c00123372c00466e580c4c06000524010a50546f6b656e4e616d65004901012c0030502253333330030011323372c00a66e58c034c178004cdcb018180419805001982e8009baa00113372c00a600e66012466e580b8cdcb1801982f00099b960123372c600660ba0020646eac0044cdcb0031803998048011bac00113372c01660186eb40044cdcb008180b1bae001574892107436f6e73747220004901044d617020004901054c697374200023372c01a66e594ccc13400440504cdcb18298009980100a1829000816118259129998270008801899b9600c3372c60a8002600460a60024609444a66609a002200826609e600660a6002600460a400297ac8491024920003046223372ca66609866e200052000100310103232533304e3370e00490000980300089919b96001300700230040023370a600c004900a19b84300500148051241012d00253330493370e002900008080a99982499b8700148008404454ccc124cdc3800a400820242a66609266e1c00520061013153330493370e0029004080a0a99982499b8700148028405454ccc124cdc3800a4018202c2a66609266e1c005200e1017153330493370e0029008080c0a99982499b870014804840645894ccc120cdc48009813240042604c0022002921024220004901022c200049010650444a757374004901015b004901025f3000490103203d200023372c0046006002920102307800303a22333003001004223372c600e004600800244464a66608266e1c005200010031323233004002001333718900119b8100248008014cdc7002240006e3400d240100232323372c6008004600800266e1400920203370800290101299981d99b8700148000400854ccc0eccdc3800a400420062a66607666e1c005200410041533303b3370e002900308028a99981d99b8700148020401854ccc0eccdc3800a4014200e2a66607666e1c005200c10081533303b3370e002900708048a99981d99b8700148040402854ccc0eccdc3800a402420162a66607666e1c0052014100c1533303b3370e002900b08068a99981d99b8700148060403854ccc0eccdc3800a4034201e2a66607666e1c005201c10101533303b3370e002900f08088b2481013000490101310049010132004901013300490101340049010135004901013600490101370049010138004901013900490101610049010162004901016300490101640049010165004901016600490101280049010950444e6f7468696e670049010120004901025b5d0049010129004901015d00223302122533302400116153330273301100332302b3013001302a0011302a0011300230290010022337029000000919b873029375400290011199810800a504a24466604200400294088cdd79ba6002374c002444666600800490001199980280124000eb4dd5800801918011ba900122223301b22533301e0011005153330213375e6050604800200c26008604e604800226004604600200246464646400aa66603c66e1d200000213232323232323232323232324994ccc098004526153302d01616302a00653330273370e9000001099191919191919191919191919191919191919191924ca6660700022930a9981f8140b181e001181e000981d003299981b99b87480000084c8c8c8c8c8c8c8c8c8c8c8c8c9265333040001149854cc11c0c058c1100194ccc104cdc3a40000042646464646464649329998220008a4c2a660960682c609000ca66608a66e1d20000021323232323232324994ccc120004526153304f03816304c00653330493370e900000109919299982599b87371a002901c0991924ca6660920022930a9982801c8b18268018a9982781b8b1bae001304c001153330493370e900100109919299982599b87371a002901c0991924ca6660920022930a9982801c8b18268018a9982781c8b1bae001304c001153304d04e16304e002304e001375400260900022a66608a66e1d20020021323232323232323232324994ccc12c004526153305203b16304f003375a002609c00260980066eb4004c12c004c12400cdd680098240008a998248250b182500118250009baa0013044001153330413370e900100109924ca66607c0022930a998228170b0a998228230b182300118230009baa0013040001303e006533303b3370e900000109919299981e99b87371a002901c0991924ca6660760022930a998210158b181f8018a998208148b1bae001303e0011533303b3370e900100109919299981e99b87371a002901c0991924ca6660760022930a998210158b181f8018a998208158b1bae001303e001153303f0401630400023040001375400260740022a660760782c607800460780026ea8004c0d8004c0d0018c080dd580218149bab0033302a2337606464a666064a6605066e1c005200013370e002901c0981c8018a9981b0150b1b8d001375c606e002646464607200860566eacc0e000ccc0b08cdd819299981999b89371a00290200981d0010a9981b81a0b1bae3039001323039002375a60700020026eacc0d8004004dd5800981800098170019bad001302d001302b003375a00260540022a660560582c605800460580026ea8004c098004c09000cdd68009811800981080118108008a998110118b181180118118009baa001223301722533301a00116132323253330203370e90010010a99981019b8f006375c6046002260460082600a60440082600a6044008604a004604a0026ea8c8c084c024004c8c084c024004c08000400894ccc05800440044ccc064cdd79810180e0009ba9002301b001001488100223375e6e9cc00c008dd398018009180e1baa00149012c7074727946726f6d28505075624b657948617368293a206d757374206265203238206279746573206c6f6e67004901317074727946726f6d2850446174615265636f72645b5d293a206c697374206973206c6f6e676572207468616e207a65726f0049012f7074727946726f6d285056616c696461746f7248617368293a206d757374206265203238206279746573206c6f6e67002533301233002233004233710900000080080088008a9980b0038b1119802118019bab3019001001223300323003375a60300020024601644a66601c002294454cc010c00cc0500044c008c04c00488ccc03c00800400c528249184e6567617469766520616d6f756e7420696e2056616c75650023300b00100214a29201387074727946726f6d2843757272656e637953796d626f6c293a206d757374206265203238206279746573206c6f6e67206f7220656d707479002333004225333007001120041322533300c3001002153301000616133004300e0032337200020066eb8c044c03400400492824810c756e736f72746564206d6170002300222533300500110061330073003300b0013002300a0012323002233002002001230022330020020015573e97adef6c605740ae692401327074727946726f6d28546f6b656e4e616d65293a206d757374206265206174206d6f7374203332204279746573206c6f6e67005744ae855ce2493f7265616368656420656e64206f662073756d207768696c65207374696c6c206e6f7420686176696e6720666f756e642074686520636f6e7374727563746f72005573caae75"
const ownershipMintCbor = "5902165902130100003232323232323232323232323232322223232323253330113370e90000010991919191919299980b991919299980d19b874800000854cc044cdc42400000c2a6602266e1c01520001332301922533301c00114a02a6646603c0022944c00cc07c0044c008c0800048c8cdd79ba73020012374e6040002603a603e0020082a6602266e1c019200013371000a9000180f001180c8009baa00c149858dd6180c002199807119b8800148000010008ccc0348cdc4240000020060026eacc054c8c05cc05cc05c004c058004c058c050014dd718098008a99ab9c49015e5061747465726e206d61746368206661696c75726520696e2027646f2720626c6f636b206174207372632f56756c63616e2f4f6e636861696e2f436f6c6c656374696f6e732f4f6e636861696e46544d696e742e68733a39313a352d31390016301500230100013754602060220026022002446660160040020062940888cccccc01002c03cdd48010009199804111929998071803800899b800010021002375a602400490001bab0011480008888cccc014cc0180100080048c888c00800cc01000448940048c010894ccc01c00448940044ccc00cc028004888c00800c4c008c02c0048894ccc01ccdd78011801800891180100189128009118019129998030008801899802180480098011805000919180111980100100091801119801001000aab9f5734aae755d0aba2230023754002aae781"

export async function evolveOnchainMetadata(  
  onchainCS: PolicyId, 
  ownerCS: PolicyId,
  tkName: string, 
  metadata: NFTMetadata,
  lucid: Lucid
): Promise<TxHash> {
  const ownAddress = await lucid.wallet.address();
  const tokenName = fromText(tkName)
  const onchainMetadataControlEvolve : SpendingValidator = 
    {type:"PlutusV2", script: applyParamsToScript(metadataControlEvolveCbor, [ownerCS])}
  const controlAddress = lucid.utils.validatorToAddress(onchainMetadataControlEvolve)

  const [referenceUtxo] = await lucid.utxosAtWithUnit(
    controlAddress,
    toUnit(onchainCS, tokenName, 100),
  );
  const oldDatum = Data.from<MetadataEvolveDatum>(referenceUtxo!.datum!, MetadataEvolveDatum)
  const evolutionInfo = {
    stage: oldDatum.extra.stage,
    stages: oldDatum.extra.stages,
    price: oldDatum.extra.price,
    recipient: oldDatum.extra.recipient,
    isPaid: false
  }
  const metadataDatum = Data.to<MetadataEvolveDatum>({
      metadata: Data.castFrom<Metadata222>(Data.fromJson(metadata), Metadata222),
      version: BigInt(1),
      extra: evolutionInfo
    }, MetadataEvolveDatum)
  const txHash = await lucid.newTx()
    .collectFrom([referenceUtxo!], Data.to(new Constr(1, [])))
    .payToContract(
      controlAddress,
      {inline: metadataDatum},
      {
        [toUnit(onchainCS, tokenName, 100)]: BigInt(1)
      },
    )
    .payToAddress(ownAddress, {[toUnit(ownerCS, fromText("Ownership"))]: BigInt(1)})
    .attachSpendingValidator(onchainMetadataControlEvolve)
    .complete() 
    .then((tx) => tx.sign().complete())
    .then((tx) => tx.submit());
    console.log("Successful Evolution: ", txHash)
    return txHash;
}
export async function mintOnchainNFT(
  tkName : string,
  metadata: NFTMetadata,
  lucid: Lucid
): Promise<TxHash> {
    const ownAddress = await lucid.wallet.address();
    const [utxo] = await lucid.wallet.getUtxos();
    const txOutId = utxo!.txHash
    const txId = new Constr(0, [txOutId])
    const txOutRefParam = new Constr(0, [txId, BigInt(utxo!.outputIndex)])
    const ownershipScript = applyParamsToScript(ownershipMintCbor, [txOutRefParam],)
    const ownershipMP : MintingPolicy = {type: "PlutusV2", script: ownershipScript}
    const ownershipCS : PolicyId = lucid.utils.mintingPolicyToId(ownershipMP);

    const onchainNFTMinting : MintingPolicy = {type:"PlutusV2", script: applyParamsToScript(onchainNFTCbor, [txOutRefParam])}
    const onchainNFTMintingCS = lucid.utils.mintingPolicyToId(onchainNFTMinting)

    const onchainMetadataControlEvolve : SpendingValidator = 
      {type:"PlutusV2", script: applyParamsToScript(metadataControlEvolveCbor, [ownershipCS])}
    const metadataControlAddress = lucid.utils.validatorToAddress(onchainMetadataControlEvolve)

    const tokenName = fromText(tkName)

    const evolutionInfo = {
      stage: BigInt(0),
      stages: BigInt(1),
      price: fromAssets({lovelace: BigInt(10_000_000)}),
      recipient: fromAddress(ownAddress),
      isPaid: false
    }
    const metadataDatum = Data.to<MetadataEvolveDatum>({
        metadata: Data.castFrom<Metadata222>(Data.fromJson(metadata), Metadata222),
        version: BigInt(1),
        extra: evolutionInfo
      }, MetadataEvolveDatum)

    const txHash = await lucid.newTx()
      .collectFrom([utxo!])
      .mintAssets({
        [toUnit(onchainNFTMintingCS, tokenName, 100)]: BigInt(1),
        [toUnit(onchainNFTMintingCS, tokenName, 222)]: BigInt(1),
        [toUnit(onchainNFTMintingCS, fromText("Royalty"), 500)]: BigInt(1),
      }, Data.to(new Constr(0, [])))
      .mintAssets({
        [toUnit(ownershipCS, fromText("Ownership"))]: BigInt(1),
      }, Data.to(new Constr(0, [])))
      .payToContract(metadataControlAddress, {inline: metadataDatum}, {[toUnit(onchainNFTMintingCS, tokenName, 100)]: BigInt(1)})
      .attachMintingPolicy(onchainNFTMinting)
      .attachMintingPolicy(ownershipMP)
      .complete()
      .then((tx) => tx.sign().complete())
      .then((tx) => tx.submit())
    return txHash;
}

export async function fundOnchainNFT(
  onchainCS: PolicyId, 
  ownerCS: PolicyId,
  tkName: string, 
  lucid: Lucid
): Promise<TxHash> {
  const ownAddress = await lucid.wallet.address();
  const tokenName = fromText(tkName)
  const onchainMetadataControlEvolve : SpendingValidator = 
    {type:"PlutusV2", script: applyParamsToScript(metadataControlEvolveCbor, [ownerCS])}
  const controlAddress = lucid.utils.validatorToAddress(onchainMetadataControlEvolve)

  const [referenceUtxo] = await lucid.utxosAtWithUnit(
    controlAddress,
    toUnit(onchainCS, tokenName, 100),
  );
  const oldDatum = Data.from<MetadataEvolveDatum>(referenceUtxo!.datum!, MetadataEvolveDatum)
  const evolutionInfo = {
    stage: oldDatum.extra.stage + BigInt(1),
    stages: oldDatum.extra.stages,
    price: oldDatum.extra.price,
    recipient: oldDatum.extra.recipient,
    isPaid: true
  }
  const metadataDatum = Data.to<MetadataEvolveDatum>({
      metadata: Data.castFrom<Metadata222>(oldDatum.metadata, Metadata222),
      version: BigInt(1),
      extra: evolutionInfo
    }, MetadataEvolveDatum)
  const txHash = await lucid.newTx()
    .collectFrom([referenceUtxo!], Data.to(new Constr(1, [])))
    .payToContract(
      controlAddress,
      {inline: metadataDatum},
      {
        [toUnit(onchainCS, tokenName, 100)]: BigInt(1)
      },
    )
    .payToAddress(toAddress(oldDatum.extra.recipient, lucid), toAssets(oldDatum.extra.price))
    .attachSpendingValidator(onchainMetadataControlEvolve)
    .complete() 
    .then((tx) => tx.sign().complete())
    .then((tx) => tx.submit());
    console.log("Successful Evolution: ", txHash)
    return txHash;
}
